DELIMITER $$
DROP PROCEDURE IF EXISTS check_payments $$
CREATE PROCEDURE check_payments(IN userid int(11))
BEGIN
DECLARE x INTEGER;
DECLARE a INTEGER;
DECLARE b INTEGER;
DECLARE c INTEGER;
DECLARE updated_cost DECIMAL;
DECLARE discount_amt DECIMAL;
DECLARE total_sum DECIMAL;
DECLARE pay_amt DECIMAL;
DECLARE final_amt DECIMAL;
DECLARE selected_quantity INTEGER;
DECLARE available_stock INTEGER;
DECLARE payment_check BOOL DEFAULT 0;
DECLARE  CONTINUE HANDLER FOR SQLEXCEPTION SET payment_check=1;

START TRANSACTION;
set a = (select product_id from carts where carts.user_id=userid);
set b = (select variant_id from carts where carts.user_id=userid);
set c = (select order_id from carts where carts.order_id=userid);
set available_stock=(select stock from variants where variants.id=b AND variants.product_id=a);
set selected_quantity = (select product_quantity from carts where carts.user_id=userid);
IF available_stock<=selected_quantity THEN
   rollback;	 
END IF;


set x = userid;

select sum((carts.product_quantity * variants.price)) into updated_cost from carts,variants where carts.variant_id = variants.id AND carts.user_id = userid;

INSERT INTO orders(id,user_id,order_date,order_status,final_cost,shipping_date,created,updated) values(c,userid,now(),"Placed",updated_cost,now(),now(),now());


set discount_amt = 10.00;
set total_sum = (select final_cost from orders where orders.user_id=userid);
set pay_amt = ((discount_amt/100)*total_sum);
set final_amt=(total_sum - pay_amt);

INSERT INTO payments   (order_id,payment_type,discount_coupon,checkout_price,payment_date,payment_status,created,updated) values (c,"cash",discount_amt,final_amt,now(),"pending",now(),now());

update variants inner join carts on variants.id=carts.variant_id set variants.stock=variants.stock - carts.product_quantity where variants.id=carts.variant_id;

INSERT INTO order_history(user_id,variant_id,product_id,product_quantity,order_id) SELECT user_id,variant_id,product_id,product_quantity,order_id FROM carts WHERE carts.user_id=userid;

DELETE FROM carts WHERE carts.user_id=userid;

IF payment_check THEN
   rollback;	 
ELSE
   commit;
END IF;

END$$
DELIMITER ;

